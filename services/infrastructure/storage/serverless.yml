service: raw-storage-for-dataplattform
frameworkVersion: '3'

dataplattform:
  dependencies:
    - ../deploymentBucket

custom:
  stagePublicBucketName: ${sls:stage}-public-raw-storagebucket

provider:
  name: aws
  stage: dev
  region: eu-central-1
  stackName: ${sls:stage}-${self:service}
  deploymentBucket:
    name: ${sls:stage}-${file(../deploymentBucket/config.yml):bucketName, file(../deploymentBucket/serverless.yml):defaultBucketName}
  runtime: nodejs16.x

resources:
  Resources:
    PublicRawStorageBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: !Sub '${self:custom.stagePublicBucketName}-${AWS::AccountId}'
        AccessControl: PublicRead

    PublicCloudFrontOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "CloudFront OAI"

    PublicRawStorageBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: PublicRawStorageBucket
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Action:
                - "s3:GetObject"
              Effect: "Allow"
              Resource: !Sub 'arn:aws:s3:::${self:custom.stagePublicBucketName}-${AWS::AccountId}/*'
              Principal:
                CanonicalUser: !GetAtt PublicCloudFrontOriginAccessIdentity.S3CanonicalUserId
            - Action:
                - "s3:ListBucket"
              Effect: "Allow"
              Resource: !GetAtt PublicRawStorageBucket.Arn
              Principal:
                CanonicalUser: !GetAtt PublicCloudFrontOriginAccessIdentity.S3CanonicalUserId

  Outputs:
    PublicRawStorageBucketName:
      Value: !Ref PublicRawStorageBucket
    S3PublicOriginAccessIdentity:
      Value: !Ref PublicCloudFrontOriginAccessIdentity
    PublicBucketName:
      Value: ${self:resources.Resources.PublicRawStorageBucket.Properties.BucketName}
      Export:
        Name: !Sub '${sls:stage}-publicBucketName'
    PublicBucketArn:
      Value: !GetAtt PublicRawStorageBucket.Arn
      Export:
        Name: ${sls:stage}-publicBucketArn
